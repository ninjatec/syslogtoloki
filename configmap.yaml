apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-agent-logs
  namespace: monitoring
data:
  agent.yaml: |

    server:
      log_level: warn

    metrics:
      wal_directory: /tmp/wal
      global:
        scrape_interval: 1m
      configs:
        - name: default
          scrape_configs:
            - job_name: agent
              static_configs:
                - targets: ['127.0.0.1:12345']

    logs:
      configs:
      - name: default
        positions:
          filename: /tmp/positions.yaml
        scrape_configs:
          - job_name: varlogs
            static_configs:
              - targets: [localhost]
                labels:
                  job: varlogs
                  __path__: /var/log/{syslog,messages,*.log}
            pipeline_stages:
              - regex:
                  expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+\+\d{2}:\d{2})\s+(?P<hostname>\S+)\s+(?P<appname>\S+)\s+(?P<message>.*)'
              - labels:
                  # RFC 5424 compliant syslog labels
                  hostname:
                  appname:
              - timestamp:
                  source: timestamp
                  format: RFC3339Nano
              - output:
                  source: message
        clients:
          - url: http://grafana-loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push
            external_labels:
              # Additional RFC 5424 standard labels
              facility: "16"  # local use 0 (16*8+0)
              version: "1"    # RFC 5424 version

    integrations:
      node_exporter:
        enabled: true
